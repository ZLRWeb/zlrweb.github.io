# Node.js æ•ˆèƒ½å„ªåŒ–èˆ‡è¨˜æ†¶é«”åˆ†æé‡é»

## ğŸ“Œ 1. æ•ˆèƒ½ç“¶é ¸å¸¸è¦‹ä¾†æº

| é¡å‹           | ç¯„ä¾‹                                 |
|----------------|--------------------------------------|
| âŒ åŒæ­¥é˜»å¡     | å¤§å‹æ’åºã€åŒæ­¥ I/O                   |
| âŒ è¨˜æ†¶é«”æ´©æ¼   | æœªé‡‹æ”¾ closureã€å…¨åŸŸè®Šæ•¸ã€éå¤§å¿«å–   |
| âŒ é »ç¹ GC      | å¤ªå¤šçŸ­å‘½ç‰©ä»¶æˆ–å¤§ç‰©ä»¶                 |
| âŒ äº‹ä»¶è¿´åœˆå¡ä½ | é•·æ™‚é–“åŸ·è¡Œçš„ callback                |
| âŒ thread pool æ»¿è¼‰ | åŒæ™‚å¤§é‡ fs/crypto éåŒæ­¥ä»»å‹™    |

## ğŸ“Œ 2. æ•ˆèƒ½å„ªåŒ–åŸå‰‡

- é¿å…åŒæ­¥å‡½å¼ï¼ˆå¦‚ fs.readFileSync()ï¼‰
- æ‹†è§£ CPU å¯†é›†ä»»å‹™ï¼ˆæ”¹ç”¨ Worker Thread æˆ–å¤–éƒ¨æœå‹™ï¼‰
- æ¸›å°‘ GC å£“åŠ›ï¼ˆé‡è¤‡åˆ©ç”¨ç‰©ä»¶ã€é¿å…ç”¢ç”ŸçŸ­å‘½å¤§ç‰©ä»¶ï¼‰
- é¿å…è¨˜æ†¶é«”æ´©æ¼ï¼ˆè§£é™¤ä¸å¿…è¦çš„é–‰åŒ…ã€ç›£æ§ç‰©ä»¶æ•¸é‡ï¼‰
- é™åˆ¶ thread pool è² è¼‰ï¼ˆåˆç†åˆ†é…éåŒæ­¥ä»»å‹™ï¼‰

## ğŸ“Œ 3. è¨˜æ†¶é«”ç®¡ç†èˆ‡åƒåœ¾å›æ”¶ï¼ˆGCï¼‰

Node.js ä½¿ç”¨ V8 è¨˜æ†¶é«”æ¨¡å‹ï¼š

| å€æ®µ              | ç”¨é€”                         |
|-------------------|------------------------------|
| New Space         | å°å‹ã€çŸ­ç”Ÿå‘½é€±æœŸçš„ç‰©ä»¶ï¼ˆå¿« GCï¼‰|
| Old Space         | å¤§å‹ã€é•·å£½å‘½ç‰©ä»¶ï¼ˆæ…¢ GCï¼‰    |
| Code Space        | å„²å­˜å·²ç·¨è­¯çš„ç¨‹å¼ç¢¼           |
| Large Object Space| å¤§æ–¼å›ºå®šå¤§å°çš„ç‰©ä»¶           |
| Map Space         | å„²å­˜å…§éƒ¨å…ƒè³‡æ–™               |

åƒåœ¾å›æ”¶ç­–ç•¥ï¼š
- Scavengeï¼šè™•ç† New Spaceï¼ˆå¿«é€Ÿï¼‰
- Mark-Sweep / Mark-Compactï¼šè™•ç† Old Spaceï¼ˆè¼ƒæ…¢ï¼Œæœƒé€ æˆå»¶é²ï¼‰

âœ… è‹¥ç‰©ä»¶å¾ New Space æ´»å¤ªä¹…ï¼Œæœƒè¢«æå‡åˆ° Old Spaceã€‚

## ğŸ“Œ 4. æå‡æ•ˆèƒ½çš„å¯¦å‹™ç­–ç•¥

### âœ… æ¸›å°‘ I/O é˜»å¡ï¼š
- æ”¹ç”¨éåŒæ­¥å‡½å¼ (fs.promises)
- ä½¿ç”¨å¿«å–å±¤ï¼ˆå¦‚ Redisï¼‰

### âœ… é¿å…äº‹ä»¶è¿´åœˆå¡ä½ï¼š
```javascript
// å°‡é‡é‹ç®—æ‹†åˆ†é¿å…é˜»å¡
setImmediate(() => doHeavyTask());
```

### âœ… ä½¿ç”¨ cluster æˆ– worker_threadsï¼š
- cluster: é©ç”¨æ–¼å¤šæ ¸å¿ƒ HTTP server
- worker_threads: é©åˆæ‹†è§£ CPU å¯†é›†é‚è¼¯

## ğŸ“Œ 5. å¸¸ç”¨æ•ˆèƒ½åˆ†æå·¥å…·

| å·¥å…·                        | åŠŸèƒ½                         |
|-----------------------------|------------------------------|
| --inspect / chrome://inspect| å•Ÿç”¨ V8 Inspectorï¼ˆChrome DevToolsï¼‰|
| node --trace-gc             | é¡¯ç¤º GC åŸ·è¡Œç´€éŒ„             |
| process.memoryUsage()       | æŸ¥çœ‹è¨˜æ†¶é«”ä½¿ç”¨ç‹€æ³           |
| clinic.js                   | è¦–è¦ºåŒ–æ•ˆèƒ½ç“¶é ¸åˆ†æ           |
| heapdump                    | ç”¢ç”Ÿè¨˜æ†¶é«”å¿«ç…§               |
| v8.getHeapStatistics()      | æŸ¥è©¢ V8 åˆ†å€è¨˜æ†¶é«”ç‹€æ…‹       |

## ğŸ“Œ 6. è§€æ¸¬è¨˜æ†¶é«”èˆ‡æ•ˆèƒ½

```javascript
console.log(process.memoryUsage());
```

```json
{
  "rss": 23068672,
  "heapTotal": 4569088,
  "heapUsed": 2923664,
  "external": 1050
}
```

- heapUsedï¼šå¯¦éš›ä½¿ç”¨ä¸­çš„ JS è¨˜æ†¶é«”
- rssï¼šå¸¸é§è¨˜æ†¶é«”ï¼ˆåŒ…å« C++ã€å¿«å–ã€å †ç–Šç­‰ï¼‰

## ğŸ“Œ 7. å¸¸è¦‹é¢è©¦é¡Œèˆ‡è§£æ

### ğŸ§  Q1ï¼šå¦‚ä½•è™•ç† Node.js ä¸­ CPU å¯†é›†ä»»å‹™ï¼Ÿ

âœ… å»ºè­°ç­”æ³•ï¼š

Node.js å–®åŸ·è¡Œç·’åŸ·è¡Œ JSï¼Œç„¡æ³•æœ‰æ•ˆè™•ç†é•·æ™‚é–“ CPU å¯†é›†ä»»å‹™ã€‚å¯å°‡æ­¤é¡ä»»å‹™ç§»è‡³ worker_threads åŸ·è¡Œï¼Œæˆ–å°‡å…¶å§”æ´¾è‡³å¤–éƒ¨å¾®æœå‹™ï¼ˆå¦‚ Python æˆ– Go å¯¦ä½œï¼‰ã€‚

---

### ğŸ§  Q2ï¼šå¦‚ä½•é¿å…è¨˜æ†¶é«”æ´©æ¼ï¼Ÿ

âœ… å»ºè­°åšæ³•ï¼š
- ç§»é™¤ä¸å†ä½¿ç”¨çš„ closure å¼•ç”¨
- æ¸…é™¤å¤§å‹ cache æˆ– map ä¸­æœªä½¿ç”¨ key
- é¿å…ç„¡é™æˆé•·çš„è³‡æ–™çµæ§‹ï¼ˆå¦‚ global arrayï¼‰
- ä½¿ç”¨å·¥å…·å¦‚ heapdump è§€å¯Ÿ retained size

---

### ğŸ§  Q3ï¼šprocess.memoryUsage() å’Œ heapdump æœ‰ä½•ä¸åŒï¼Ÿ

| å·¥å…·                  | èªªæ˜                                 |
|-----------------------|--------------------------------------|
| process.memoryUsage() | å³æ™‚æ•¸å­—ï¼Œå¿«é€ŸæŒæ¡è¶¨å‹¢               |
| heapdump              | è©³ç´°è¨˜æ†¶é«”å¿«ç…§ï¼Œå¯ç”¨ Chrome DevTools åˆ†æ |

## ğŸ“˜ å»¶ä¼¸å­¸ç¿’è³‡æº

- [Node.js Poor Performance Best Practices (å®˜æ–¹)](https://nodejs.org/en/learn/diagnostics/poor-performance#poor-performance)
- [V8 Memory Management Docs](https://v8.dev/docs/memory-management)
- [NearForm Clinic å·¥å…·](https://clinicjs.org/)
- [Chrome DevTools: Memory Profiler](https://developer.chrome.com/docs/devtools/memory)